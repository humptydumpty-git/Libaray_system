<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Management System - Professional Edition</title>
    <link rel="stylesheet" href="library.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ“š Library Management System</h1>
            <p>Professional Library Management with Enhanced Security & Features</p>
        </header>

        <nav class="tabs">
            <button class="tab-btn active" data-tab="add-book">Add Book</button>
            <button class="tab-btn" data-tab="view-books">View Books</button>
            <button class="tab-btn" data-tab="search-books">Search Books</button>
            <button class="tab-btn" data-tab="borrowing">Borrowing</button>
            <button class="tab-btn" data-tab="reports">Reports</button>
            <button class="tab-btn" data-tab="settings">Settings</button>
        </nav>

        <main>
            <!-- Add Book Section -->
            <section id="add-book" class="tab-content active">
                <div class="form-container">
                    <h2>Add New Book</h2>
                    <form id="book-form">
                        <div class="form-group">
                            <label for="title">Book Title *</label>
                            <input type="text" id="title" name="title" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="author">Author *</label>
                            <input type="text" id="author" name="author" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="isbn">ISBN</label>
                            <input type="text" id="isbn" name="isbn" placeholder="ISBN-10 or ISBN-13">
                            <small class="form-hint">Optional: ISBN-10 (10 digits) or ISBN-13 (13 digits starting with 978/979)</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="genre">Genre</label>
                            <select id="genre" name="genre">
                                <option value="">Select Genre</option>
                                <option value="Fiction">Fiction</option>
                                <option value="Non-Fiction">Non-Fiction</option>
                                <option value="Science Fiction">Science Fiction</option>
                                <option value="Fantasy">Fantasy</option>
                                <option value="Mystery">Mystery</option>
                                <option value="Romance">Romance</option>
                                <option value="Biography">Biography</option>
                                <option value="History">History</option>
                                <option value="Science">Science</option>
                                <option value="Technology">Technology</option>
                                <option value="Education">Education</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="publication-year">Publication Year</label>
                            <input type="number" id="publication-year" name="publication-year" min="1000" max="2025">
                            <small class="form-hint">Enter year between 1000 and 2025</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select id="status" name="status">
                                <option value="Available">Available</option>
                                <option value="Borrowed">Borrowed</option>
                                <option value="Reserved">Reserved</option>
                                <option value="Lost">Lost</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="location">Location/Shelf</label>
                            <input type="text" id="location" name="location" placeholder="e.g., Shelf A-1">
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Add Book</button>
                        <button type="reset" class="btn btn-secondary">Clear Form</button>
                    </form>
                </div>
            </section>

            <!-- View Books Section -->
            <section id="view-books" class="tab-content">
                <div class="books-container">
                    <h2>Library Books</h2>
                    <div class="books-stats">
                        <div class="stat-card">
                            <span class="stat-number" id="total-books">0</span>
                            <span class="stat-label">Total Books</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="available-books">0</span>
                            <span class="stat-label">Available</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="borrowed-books">0</span>
                            <span class="stat-label">Borrowed</span>
                        </div>
                    </div>
                    
                    <div class="books-grid" id="books-grid">
                        <!-- Books will be dynamically added here -->
                    </div>
                </div>
            </section>

            <!-- Search Books Section -->
            <section id="search-books" class="tab-content">
                <div class="search-container">
                    <h2>Search Books</h2>
                    
                    <div class="search-form">
                        <div class="search-group">
                            <input type="text" id="search-input" placeholder="Search by title, author, or ISBN...">
                            <button id="search-btn" class="btn btn-primary">Search</button>
                        </div>
                        
                        <div class="filter-group">
                            <select id="filter-genre">
                                <option value="">All Genres</option>
                                <option value="Fiction">Fiction</option>
                                <option value="Non-Fiction">Non-Fiction</option>
                                <option value="Science Fiction">Science Fiction</option>
                                <option value="Fantasy">Fantasy</option>
                                <option value="Mystery">Mystery</option>
                                <option value="Romance">Romance</option>
                                <option value="Biography">Biography</option>
                                <option value="History">History</option>
                                <option value="Science">Science</option>
                                <option value="Technology">Technology</option>
                                <option value="Education">Education</option>
                                <option value="Other">Other</option>
                            </select>
                            
                            <select id="filter-status">
                                <option value="">All Status</option>
                                <option value="Available">Available</option>
                                <option value="Borrowed">Borrowed</option>
                                <option value="Reserved">Reserved</option>
                                <option value="Lost">Lost</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="search-results" id="search-results">
                        <!-- Search results will be displayed here -->
                    </div>
                </div>
            </section>

            <!-- Borrowing Section -->
            <section id="borrowing" class="tab-content">
                <div class="borrowing-container">
                    <h2>Borrowing Management</h2>
                    
                    <div class="borrowing-actions">
                        <button id="register-borrower-btn" class="btn btn-primary">Register New Borrower</button>
                        <button id="checkout-btn" class="btn btn-primary">Check Out Book</button>
                        <button id="return-btn" class="btn btn-primary">Return Book</button>
                        <button id="view-overdue-btn" class="btn btn-warning">View Overdue Books</button>
                    </div>

                    <div id="borrowing-content">
                        <div class="borrowers-list" id="borrowers-list">
                            <!-- Borrowers will be displayed here -->
                        </div>
                        <div class="transactions-list" id="transactions-list">
                            <!-- Transactions will be displayed here -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="reports" class="tab-content">
                <div class="reports-container">
                    <h2>Reports & Analytics</h2>
                    
                    <div class="reports-actions">
                        <button id="export-json-btn" class="btn btn-primary">Export to JSON</button>
                        <button id="export-csv-btn" class="btn btn-primary">Export to CSV</button>
                        <button id="import-json-btn" class="btn btn-secondary">Import from JSON</button>
                        <button id="import-csv-btn" class="btn btn-secondary">Import from CSV</button>
                        <button id="backup-btn" class="btn btn-success">Create Backup</button>
                        <button id="restore-btn" class="btn btn-warning">Restore from Backup</button>
                    </div>

                    <div class="reports-stats" id="reports-stats">
                        <!-- Reports statistics will be displayed here -->
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings" class="tab-content">
                <div class="settings-container">
                    <h2>System Settings</h2>
                    
                    <div class="settings-section">
                        <h3>Data Management</h3>
                        <button id="clear-all-data-btn" class="btn btn-danger">Clear All Data</button>
                        <button id="export-audit-logs-btn" class="btn btn-secondary">Export Audit Logs</button>
                    </div>

                    <div class="settings-section">
                        <h3>Borrowing Settings</h3>
                        <div class="form-group">
                            <label for="default-loan-days">Default Loan Period (days)</label>
                            <input type="number" id="default-loan-days" min="1" max="365" value="14">
                        </div>
                        <div class="form-group">
                            <label for="daily-fine">Daily Fine Amount ($)</label>
                            <input type="number" id="daily-fine" min="0" step="0.01" value="0.50">
                        </div>
                        <button id="save-settings-btn" class="btn btn-primary">Save Settings</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Book Details Modal -->
    <div id="book-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Book Details</h2>
            <div id="book-details">
                <!-- Book details will be displayed here -->
            </div>
            <div class="modal-actions">
                <button id="edit-book" class="btn btn-primary">Edit Book</button>
                <button id="checkout-book-btn" class="btn btn-success">Check Out</button>
                <button id="delete-book" class="btn btn-danger">Delete Book</button>
            </div>
        </div>
    </div>

    <!-- Edit Book Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Edit Book</h2>
            <form id="edit-form">
                <div class="form-group">
                    <label for="edit-title">Book Title *</label>
                    <input type="text" id="edit-title" name="title" required>
                </div>
                
                <div class="form-group">
                    <label for="edit-author">Author *</label>
                    <input type="text" id="edit-author" name="author" required>
                </div>
                
                <div class="form-group">
                    <label for="edit-isbn">ISBN</label>
                    <input type="text" id="edit-isbn" name="isbn">
                </div>
                
                <div class="form-group">
                    <label for="edit-genre">Genre</label>
                    <select id="edit-genre" name="genre">
                        <option value="">Select Genre</option>
                        <option value="Fiction">Fiction</option>
                        <option value="Non-Fiction">Non-Fiction</option>
                        <option value="Science Fiction">Science Fiction</option>
                        <option value="Fantasy">Fantasy</option>
                        <option value="Mystery">Mystery</option>
                        <option value="Romance">Romance</option>
                        <option value="Biography">Biography</option>
                        <option value="History">History</option>
                        <option value="Science">Science</option>
                        <option value="Technology">Technology</option>
                        <option value="Education">Education</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="edit-publication-year">Publication Year</label>
                    <input type="number" id="edit-publication-year" name="publication-year" min="1000" max="2024">
                </div>
                
                <div class="form-group">
                    <label for="edit-status">Status</label>
                    <select id="edit-status" name="status">
                        <option value="Available">Available</option>
                        <option value="Borrowed">Borrowed</option>
                        <option value="Reserved">Reserved</option>
                        <option value="Lost">Lost</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="edit-location">Location/Shelf</label>
                    <input type="text" id="edit-location" name="location" placeholder="e.g., Shelf A-1">
                </div>
                
                <button type="submit" class="btn btn-primary">Update Book</button>
            </form>
        </div>
    </div>

    <!-- Register Borrower Modal -->
    <div id="borrower-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Register New Borrower</h2>
            <form id="borrower-form">
                <div class="form-group">
                    <label for="borrower-name">Name *</label>
                    <input type="text" id="borrower-name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="borrower-email">Email</label>
                    <input type="email" id="borrower-email" name="email">
                </div>
                <div class="form-group">
                    <label for="borrower-phone">Phone</label>
                    <input type="tel" id="borrower-phone" name="phone">
                </div>
                <div class="form-group">
                    <label for="borrower-address">Address</label>
                    <textarea id="borrower-address" name="address" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Register Borrower</button>
            </form>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkout-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Check Out Book</h2>
            <form id="checkout-form">
                <div class="form-group">
                    <label for="checkout-book-select">Select Book *</label>
                    <select id="checkout-book-select" name="bookId" required></select>
                </div>
                <div class="form-group">
                    <label for="checkout-borrower-select">Select Borrower *</label>
                    <select id="checkout-borrower-select" name="borrowerId" required></select>
                </div>
                <div class="form-group">
                    <label for="checkout-loan-days">Loan Period (days)</label>
                    <input type="number" id="checkout-loan-days" name="loanDays" min="1" max="365" value="14">
                </div>
                <button type="submit" class="btn btn-primary">Check Out</button>
            </form>
        </div>
    </div>

    <!-- Import File Input (hidden) -->
    <input type="file" id="import-file-input" accept=".json,.csv" style="display: none;">

    <!-- Scripts -->
    <script src="js/validation.js"></script>
    <script src="js/audit-logger.js"></script>
    <script src="js/borrowing-system.js"></script>
    <script src="js/data-export.js"></script>
    
    <script>
        // Enhanced Library Management JavaScript
        class LibraryManager {
            constructor() {
                this.books = JSON.parse(localStorage.getItem('libraryBooks')) || [];
                this.currentBookId = null;
                this.auditLogger = new AuditLogger();
                this.borrowingSystem = new BorrowingSystem();
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.displayBooks();
                this.updateStats();
            }

            setupEventListeners() {
                // Tab switching
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.switchTab(e.target.dataset.tab);
                    });
                });

                // Form submissions
                document.getElementById('book-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addBook();
                });

                document.getElementById('edit-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.updateBook();
                });

                // Search functionality
                document.getElementById('search-btn').addEventListener('click', () => {
                    this.searchBooks();
                });

                document.getElementById('search-input').addEventListener('input', () => {
                    this.searchBooks();
                });

                document.getElementById('filter-genre').addEventListener('change', () => {
                    this.searchBooks();
                });

                document.getElementById('filter-status').addEventListener('change', () => {
                    this.searchBooks();
                });

                // Modal functionality
                document.querySelectorAll('.close').forEach(closeBtn => {
                    closeBtn.addEventListener('click', (e) => {
                        e.target.closest('.modal').style.display = 'none';
                    });
                });

                // Edit and delete buttons
                document.getElementById('edit-book').addEventListener('click', () => {
                    this.showEditModal();
                });

                document.getElementById('delete-book').addEventListener('click', () => {
                    this.deleteBook();
                });

                // Close modals when clicking outside
                window.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) {
                        e.target.style.display = 'none';
                    }
                });
            }

            switchTab(tabName) {
                // Remove active class from all tabs and content
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                // Add active class to selected tab and content
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                document.getElementById(tabName).classList.add('active');

                if (tabName === 'view-books') {
                    this.displayBooks();
                    this.updateStats();
                }
            }

            addBook() {
                const formData = new FormData(document.getElementById('book-form'));
                const bookData = {
                    title: formData.get('title'),
                    author: formData.get('author'),
                    isbn: formData.get('isbn'),
                    genre: formData.get('genre'),
                    publicationYear: formData.get('publication-year'),
                    status: formData.get('status'),
                    location: formData.get('location')
                };

                // Validate book data
                const validation = Validator.validateBook(bookData);
                if (!validation.valid) {
                    this.showNotification(validation.errors.join(', '), 'error');
                    return;
                }

                // Check for duplicate ISBN
                if (bookData.isbn && Validator.isDuplicateISBN(bookData.isbn, this.books)) {
                    this.showNotification('A book with this ISBN already exists!', 'error');
                    return;
                }

                // Sanitize inputs
                const book = {
                    id: Date.now().toString(),
                    title: Validator.sanitize(bookData.title),
                    author: Validator.sanitize(bookData.author),
                    isbn: bookData.isbn ? Validator.sanitize(bookData.isbn) : '',
                    genre: bookData.genre ? Validator.sanitize(bookData.genre) : '',
                    publicationYear: bookData.publicationYear || null,
                    status: bookData.status || 'Available',
                    location: bookData.location ? Validator.sanitize(bookData.location) : '',
                    dateAdded: new Date().toISOString()
                };

                this.books.push(book);
                this.saveBooks();
                
                // Log the action
                this.auditLogger.log('CREATE', 'BOOK', book.id, { title: book.title });
                
                document.getElementById('book-form').reset();
                this.displayBooks();
                this.updateStats();
                
                this.showNotification('Book added successfully!', 'success');
            }

            updateBook() {
                const bookIndex = this.books.findIndex(book => book.id === this.currentBookId);
                if (bookIndex === -1) {
                    this.showNotification('Book not found!', 'error');
                    return;
                }

                const formData = new FormData(document.getElementById('edit-form'));
                const bookData = {
                    title: formData.get('title'),
                    author: formData.get('author'),
                    isbn: formData.get('isbn'),
                    genre: formData.get('genre'),
                    publicationYear: formData.get('publication-year'),
                    status: formData.get('status'),
                    location: formData.get('location')
                };

                // Validate book data
                const validation = Validator.validateBook(bookData);
                if (!validation.valid) {
                    this.showNotification(validation.errors.join(', '), 'error');
                    return;
                }

                // Check for duplicate ISBN (excluding current book)
                if (bookData.isbn && Validator.isDuplicateISBN(bookData.isbn, this.books, this.currentBookId)) {
                    this.showNotification('A book with this ISBN already exists!', 'error');
                    return;
                }

                const oldBook = { ...this.books[bookIndex] };
                
                // Sanitize and update
                this.books[bookIndex] = {
                    ...this.books[bookIndex],
                    title: Validator.sanitize(bookData.title),
                    author: Validator.sanitize(bookData.author),
                    isbn: bookData.isbn ? Validator.sanitize(bookData.isbn) : '',
                    genre: bookData.genre ? Validator.sanitize(bookData.genre) : '',
                    publicationYear: bookData.publicationYear || null,
                    status: bookData.status || 'Available',
                    location: bookData.location ? Validator.sanitize(bookData.location) : ''
                };

                this.saveBooks();
                
                // Log the action
                this.auditLogger.log('UPDATE', 'BOOK', this.currentBookId, {
                    old: oldBook,
                    new: this.books[bookIndex]
                });
                
                this.displayBooks();
                this.updateStats();
                document.getElementById('edit-modal').style.display = 'none';
                
                this.showNotification('Book updated successfully!', 'success');
            }

            deleteBook() {
                const book = this.books.find(b => b.id === this.currentBookId);
                if (!book) {
                    this.showNotification('Book not found!', 'error');
                    return;
                }

                // Check if book is currently borrowed
                const activeTransactions = this.borrowingSystem.getActiveTransactions(this.currentBookId);
                if (activeTransactions.length > 0) {
                    this.showNotification('Cannot delete book that is currently checked out!', 'error');
                    return;
                }

                if (confirm(`Are you sure you want to delete "${book.title}"?`)) {
                    this.books = this.books.filter(book => book.id !== this.currentBookId);
                    this.saveBooks();
                    
                    // Log the action
                    this.auditLogger.log('DELETE', 'BOOK', this.currentBookId, { title: book.title });
                    
                    this.displayBooks();
                    this.updateStats();
                    document.getElementById('book-modal').style.display = 'none';
                    
                    this.showNotification('Book deleted successfully!', 'success');
                }
            }

            displayBooks() {
                const booksGrid = document.getElementById('books-grid');
                booksGrid.innerHTML = '';

                if (this.books.length === 0) {
                    booksGrid.innerHTML = '<div class="no-books">No books in the library yet. Add some books to get started!</div>';
                    return;
                }

                this.books.forEach(book => {
                    const bookCard = this.createBookCard(book);
                    booksGrid.appendChild(bookCard);
                });
            }

            createBookCard(book) {
                const card = document.createElement('div');
                card.className = 'book-card';
                card.innerHTML = `
                    <div class="book-cover">
                        <div class="book-icon">ðŸ“–</div>
                    </div>
                    <div class="book-info">
                        <h3 class="book-title">${book.title}</h3>
                        <p class="book-author">by ${book.author}</p>
                        <p class="book-genre">${book.genre || 'No genre specified'}</p>
                        <span class="book-status ${book.status.toLowerCase()}">${book.status}</span>
                    </div>
                `;

                card.addEventListener('click', () => {
                    this.showBookDetails(book);
                });

                return card;
            }

            showBookDetails(book) {
                this.currentBookId = book.id;
                const modal = document.getElementById('book-modal');
                const details = document.getElementById('book-details');
                
                details.innerHTML = `
                    <div class="book-detail">
                        <h3>${book.title}</h3>
                        <p><strong>Author:</strong> ${book.author}</p>
                        <p><strong>ISBN:</strong> ${book.isbn || 'Not specified'}</p>
                        <p><strong>Genre:</strong> ${book.genre || 'Not specified'}</p>
                        <p><strong>Publication Year:</strong> ${book.publicationYear || 'Not specified'}</p>
                        <p><strong>Status:</strong> <span class="status ${book.status.toLowerCase()}">${book.status}</span></p>
                        <p><strong>Location:</strong> ${book.location || 'Not specified'}</p>
                        <p><strong>Date Added:</strong> ${new Date(book.dateAdded).toLocaleDateString()}</p>
                    </div>
                `;
                
                modal.style.display = 'block';
            }

            showEditModal() {
                const book = this.books.find(book => book.id === this.currentBookId);
                if (!book) return;

                document.getElementById('edit-title').value = book.title;
                document.getElementById('edit-author').value = book.author;
                document.getElementById('edit-isbn').value = book.isbn || '';
                document.getElementById('edit-genre').value = book.genre || '';
                document.getElementById('edit-publication-year').value = book.publicationYear || '';
                document.getElementById('edit-status').value = book.status;
                document.getElementById('edit-location').value = book.location || '';

                document.getElementById('book-modal').style.display = 'none';
                document.getElementById('edit-modal').style.display = 'block';
            }

            searchBooks() {
                const searchTerm = document.getElementById('search-input').value.toLowerCase();
                const genreFilter = document.getElementById('filter-genre').value;
                const statusFilter = document.getElementById('filter-status').value;
                const resultsContainer = document.getElementById('search-results');

                let filteredBooks = this.books.filter(book => {
                    const matchesSearch = !searchTerm || 
                        book.title.toLowerCase().includes(searchTerm) ||
                        book.author.toLowerCase().includes(searchTerm) ||
                        (book.isbn && book.isbn.toLowerCase().includes(searchTerm));

                    const matchesGenre = !genreFilter || book.genre === genreFilter;
                    const matchesStatus = !statusFilter || book.status === statusFilter;

                    return matchesSearch && matchesGenre && matchesStatus;
                });

                this.displaySearchResults(filteredBooks, resultsContainer);
            }

            displaySearchResults(books, container) {
                container.innerHTML = '';

                if (books.length === 0) {
                    container.innerHTML = '<div class="no-results">No books found matching your criteria.</div>';
                    return;
                }

                books.forEach(book => {
                    const resultCard = this.createBookCard(book);
                    container.appendChild(resultCard);
                });
            }

            updateStats() {
                const totalBooks = this.books.length;
                const availableBooks = this.books.filter(book => book.status === 'Available').length;
                const borrowedBooks = this.books.filter(book => book.status === 'Borrowed').length;

                document.getElementById('total-books').textContent = totalBooks;
                document.getElementById('available-books').textContent = availableBooks;
                document.getElementById('borrowed-books').textContent = borrowedBooks;
            }

            saveBooks() {
                localStorage.setItem('libraryBooks', JSON.stringify(this.books));
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                document.body.appendChild(notification);
                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }

            // Enhanced methods for new features
            setupEnhancedEventListeners() {
                // Borrowing system
                document.getElementById('register-borrower-btn')?.addEventListener('click', () => {
                    document.getElementById('borrower-modal').style.display = 'block';
                });

                document.getElementById('borrower-form')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.registerBorrower();
                });

                document.getElementById('checkout-btn')?.addEventListener('click', () => {
                    this.showCheckoutModal();
                });

                document.getElementById('checkout-form')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.checkoutBook();
                });

                document.getElementById('return-btn')?.addEventListener('click', () => {
                    this.showReturnModal();
                });

                document.getElementById('view-overdue-btn')?.addEventListener('click', () => {
                    this.showOverdueBooks();
                });

                // Export/Import
                document.getElementById('export-json-btn')?.addEventListener('click', () => {
                    DataExporter.exportBooksToJSON(this.books);
                    this.showNotification('Books exported to JSON successfully!', 'success');
                });

                document.getElementById('export-csv-btn')?.addEventListener('click', () => {
                    DataExporter.exportBooksToCSV(this.books);
                    this.showNotification('Books exported to CSV successfully!', 'success');
                });

                document.getElementById('import-json-btn')?.addEventListener('click', () => {
                    document.getElementById('import-file-input').accept = '.json';
                    document.getElementById('import-file-input').click();
                });

                document.getElementById('import-csv-btn')?.addEventListener('click', () => {
                    document.getElementById('import-file-input').accept = '.csv';
                    document.getElementById('import-file-input').click();
                });

                document.getElementById('import-file-input')?.addEventListener('change', (e) => {
                    this.handleFileImport(e.target.files[0]);
                });

                document.getElementById('backup-btn')?.addEventListener('click', () => {
                    this.createBackup();
                });

                document.getElementById('restore-btn')?.addEventListener('click', () => {
                    this.restoreFromBackup();
                });

                // Settings
                document.getElementById('export-audit-logs-btn')?.addEventListener('click', () => {
                    const logs = this.auditLogger.exportLogs();
                    DataExporter.downloadFile(logs, `audit-logs-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
                    this.showNotification('Audit logs exported successfully!', 'success');
                });

                document.getElementById('clear-all-data-btn')?.addEventListener('click', () => {
                    if (confirm('WARNING: This will delete ALL data including books, borrowers, and transactions. Are you absolutely sure?')) {
                        if (confirm('This action cannot be undone. Type "DELETE" to confirm.')) {
                            localStorage.clear();
                            location.reload();
                        }
                    }
                });

                // Checkout from book details
                document.getElementById('checkout-book-btn')?.addEventListener('click', () => {
                    this.showCheckoutModal(this.currentBookId);
                });
            }

            registerBorrower() {
                const formData = new FormData(document.getElementById('borrower-form'));
                const borrowerData = {
                    name: formData.get('name'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    address: formData.get('address')
                };

                const result = this.borrowingSystem.registerBorrower(borrowerData);
                if (result.success) {
                    this.auditLogger.log('CREATE', 'BORROWER', result.borrower.id, { name: result.borrower.name });
                    document.getElementById('borrower-form').reset();
                    document.getElementById('borrower-modal').style.display = 'none';
                    this.showNotification('Borrower registered successfully!', 'success');
                    this.displayBorrowers();
                } else {
                    this.showNotification(result.error, 'error');
                }
            }

            showCheckoutModal(bookId = null) {
                const modal = document.getElementById('checkout-modal');
                const bookSelect = document.getElementById('checkout-book-select');
                const borrowerSelect = document.getElementById('checkout-borrower-select');

                // Populate books (only available ones)
                bookSelect.innerHTML = '<option value="">Select a book</option>';
                this.books.filter(b => b.status === 'Available').forEach(book => {
                    const option = document.createElement('option');
                    option.value = book.id;
                    option.textContent = `${book.title} by ${book.author}`;
                    if (bookId === book.id) option.selected = true;
                    bookSelect.appendChild(option);
                });

                // Populate borrowers
                borrowerSelect.innerHTML = '<option value="">Select a borrower</option>';
                this.borrowingSystem.getAllBorrowers().forEach(borrower => {
                    const option = document.createElement('option');
                    option.value = borrower.id;
                    option.textContent = `${borrower.name}${borrower.email ? ' (' + borrower.email + ')' : ''}`;
                    borrowerSelect.appendChild(option);
                });

                modal.style.display = 'block';
            }

            checkoutBook() {
                const formData = new FormData(document.getElementById('checkout-form'));
                const bookId = formData.get('bookId');
                const borrowerId = formData.get('borrowerId');
                const loanDays = parseInt(formData.get('loanDays')) || 14;

                const result = this.borrowingSystem.checkoutBook(bookId, borrowerId, loanDays);
                if (result.success) {
                    // Update book status
                    const bookIndex = this.books.findIndex(b => b.id === bookId);
                    if (bookIndex !== -1) {
                        this.books[bookIndex].status = 'Borrowed';
                        this.saveBooks();
                    }

                    this.auditLogger.log('BORROW', 'BOOK', bookId, {
                        borrowerId: borrowerId,
                        dueDate: result.transaction.dueDate
                    });

                    document.getElementById('checkout-form').reset();
                    document.getElementById('checkout-modal').style.display = 'none';
                    this.showNotification('Book checked out successfully!', 'success');
                    this.displayBooks();
                    this.updateStats();
                } else {
                    this.showNotification(result.error, 'error');
                }
            }

            showReturnModal() {
                const overdueBooks = this.borrowingSystem.getOverdueBooks();
                if (overdueBooks.length === 0) {
                    this.showNotification('No books to return at this time.', 'info');
                    return;
                }

                // Show list of borrowed books for return
                let message = 'Select a book to return:\n\n';
                overdueBooks.forEach((transaction, index) => {
                    const book = this.books.find(b => b.id === transaction.bookId);
                    const borrower = this.borrowingSystem.getBorrower(transaction.borrowerId);
                    const fine = this.borrowingSystem.calculateFine(transaction.id);
                    message += `${index + 1}. ${book ? book.title : 'Unknown'} - ${borrower ? borrower.name : 'Unknown'}`;
                    if (fine > 0) message += ` (Fine: $${fine.toFixed(2)})`;
                    message += '\n';
                });

                // For now, use simple prompt - can be enhanced with modal
                const selection = prompt(message + '\nEnter book number to return:');
                if (selection) {
                    const index = parseInt(selection) - 1;
                    if (index >= 0 && index < overdueBooks.length) {
                        this.returnBook(overdueBooks[index].id);
                    }
                }
            }

            returnBook(transactionId) {
                const transaction = this.borrowingSystem.transactions.find(t => t.id === transactionId);
                if (!transaction) {
                    this.showNotification('Transaction not found!', 'error');
                    return;
                }

                const fine = this.borrowingSystem.calculateFine(transactionId);
                const result = this.borrowingSystem.returnBook(transactionId, fine);

                if (result.success) {
                    // Update book status
                    const bookIndex = this.books.findIndex(b => b.id === transaction.bookId);
                    if (bookIndex !== -1) {
                        this.books[bookIndex].status = 'Available';
                        this.saveBooks();
                    }

                    this.auditLogger.log('RETURN', 'BOOK', transaction.bookId, {
                        fineAmount: fine,
                        returnDate: result.transaction.returnDate
                    });

                    this.showNotification(`Book returned successfully!${fine > 0 ? ' Fine: $' + fine.toFixed(2) : ''}`, 'success');
                    this.displayBooks();
                    this.updateStats();
                } else {
                    this.showNotification(result.error, 'error');
                }
            }

            showOverdueBooks() {
                const overdue = this.borrowingSystem.getOverdueBooks();
                if (overdue.length === 0) {
                    this.showNotification('No overdue books!', 'success');
                    return;
                }

                let message = `Overdue Books (${overdue.length}):\n\n`;
                overdue.forEach(transaction => {
                    const book = this.books.find(b => b.id === transaction.bookId);
                    const borrower = this.borrowingSystem.getBorrower(transaction.borrowerId);
                    const fine = this.borrowingSystem.calculateFine(transaction.id);
                    const dueDate = new Date(transaction.dueDate).toLocaleDateString();
                    message += `â€¢ ${book ? book.title : 'Unknown'} - ${borrower ? borrower.name : 'Unknown'}\n`;
                    message += `  Due: ${dueDate}, Fine: $${fine.toFixed(2)}\n\n`;
                });

                alert(message);
            }

            displayBorrowers() {
                const container = document.getElementById('borrowers-list');
                if (!container) return;

                const borrowers = this.borrowingSystem.getAllBorrowers();
                container.innerHTML = '<h3>Registered Borrowers</h3>';
                
                if (borrowers.length === 0) {
                    container.innerHTML += '<p>No borrowers registered yet.</p>';
                    return;
                }

                borrowers.forEach(borrower => {
                    const div = document.createElement('div');
                    div.className = 'borrower-card';
                    div.innerHTML = `
                        <h4>${borrower.name}</h4>
                        <p>${borrower.email || 'No email'}</p>
                        <p>${borrower.phone || 'No phone'}</p>
                    `;
                    container.appendChild(div);
                });
            }

            handleFileImport(file) {
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    let result;

                    if (file.name.endsWith('.json')) {
                        result = DataExporter.importFromJSON(content);
                    } else if (file.name.endsWith('.csv')) {
                        result = DataExporter.importFromCSV(content);
                    } else {
                        this.showNotification('Unsupported file format!', 'error');
                        return;
                    }

                    if (result.success && result.books.length > 0) {
                        // Merge with existing books (avoid duplicates by ISBN)
                        result.books.forEach(book => {
                            if (!book.isbn || !Validator.isDuplicateISBN(book.isbn, this.books)) {
                                this.books.push(book);
                                this.auditLogger.log('IMPORT', 'BOOK', book.id, { title: book.title });
                            }
                        });
                        this.saveBooks();
                        this.displayBooks();
                        this.updateStats();
                        this.showNotification(`Imported ${result.books.length} book(s) successfully!`, 'success');
                    } else {
                        this.showNotification('Import failed: ' + (result.errors ? result.errors.join(', ') : 'Invalid file'), 'error');
                    }
                };
                reader.readAsText(file);
            }

            createBackup() {
                const backup = DataExporter.createBackup({
                    books: this.books,
                    borrowers: this.borrowingSystem.borrowers,
                    transactions: this.borrowingSystem.transactions,
                    auditLogs: this.auditLogger.logs
                });
                DataExporter.downloadFile(backup, `library-backup-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
                this.showNotification('Backup created successfully!', 'success');
            }

            restoreFromBackup() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const result = DataExporter.restoreFromBackup(event.target.result);
                        if (result.success) {
                            if (confirm('This will replace all current data. Continue?')) {
                                if (result.data.books) this.books = result.data.books;
                                if (result.data.borrowers) this.borrowingSystem.borrowers = result.data.borrowers;
                                if (result.data.transactions) this.borrowingSystem.transactions = result.data.transactions;
                                if (result.data.auditLogs) this.auditLogger.logs = result.data.auditLogs;

                                this.saveBooks();
                                this.borrowingSystem.saveBorrowers();
                                this.borrowingSystem.saveTransactions();
                                this.auditLogger.saveLogs();

                                this.displayBooks();
                                this.updateStats();
                                this.showNotification('Backup restored successfully!', 'success');
                            }
                        } else {
                            this.showNotification('Restore failed: ' + result.error, 'error');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            }
        }

        // Initialize the library manager when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            const manager = new LibraryManager();
            manager.setupEnhancedEventListeners();
            
            // Update publication year max to current year + 1
            const currentYear = new Date().getFullYear();
            document.getElementById('publication-year')?.setAttribute('max', currentYear + 1);
            document.getElementById('edit-publication-year')?.setAttribute('max', currentYear + 1);
        });
    </script>
</body>
</html>
